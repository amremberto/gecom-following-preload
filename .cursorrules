# === Cursor Rules for .NET 9 / C# 13 ===

project_context:
  tech_stack: |
    .NET 9, C# 13, ASP.NET Core Web API (controllers), EF Core, Serilog,
    AutoMapper, FluentValidation, MediatR (CQRS), IOptions, JWT auth,
    API versioning, ProblemDetails, HealthChecks, Caching, Unit/Integration tests.

coding_guidelines:
  instructions: |
    - Usar C# 13 y nullability enabled.
    - Favor Guid como identificador.
    - Usar records para DTOs inmutables; classes para entidades/agregados.
    - Inyecci√≥n de dependencias con primary constructors cuando aplique.
    - Seguir SOLID y Clean Architecture (Domain, Application, Infrastructure, WebAPI, SharedKernel/Contracts).
    - Preferir controladores a Minimal APIs.
    - Validar modelos con FluentValidation + filtros autom√°ticos.
    - Manejo de errores con ProblemDetails y middleware.
    - Logging con Serilog (structured logging, no logs en controladores salvo contexto).
    - Configuraci√≥n tipada (IOptions<T>) y archivos por entorno.
    - Autenticaci√≥n/Autorizaci√≥n con JWT/Policies/Roles; [Authorize] por defecto.
    - EF Core: No l√≥gica de negocio en DbContext; usar repositorios o UoW s√≥lo si agregan valor.
    - Async/await para I/O; evitar .Result/.Wait().
    - `is null` / `is not null` en vez de `== null`/`!= null`.
    - Validar argumentos con `ArgumentNullException.ThrowIfNull(...)`.
    - Evitar magia: tipos expl√≠citos (no `var` salvo obvio).
    - Versionado de API (e.g., v1, v2) y Swagger con auth.

architecture_guards:
  instructions: |
    - WebAPI no referencia Infrastructure directamente si Application ya lo abstrae.
    - Domain no referencia a ning√∫n otro proyecto.
    - Application s√≥lo referencia Domain y Contracts/SharedKernel.
    - Infrastructure referencia Application/Domain para implementaciones.
    - Prohibido usar DateTime.Now directamente; usar IClock/TimeProvider.
    - No acceder a HttpContext en capa Application/Domain.
    - Evitar est√°ticos con estado compartido.

commit_message:
  instructions: |
    Formato estricto:
    1. Una l√≠nea de t√≠tulo breve con un emoji representativo y una descripci√≥n general corta.
       Usa uno de estos emojis seg√∫n el tipo de cambio:
       - ‚ú®  (nueva funcionalidad o feature)
       - üêõ  (fix de bug)
       - üîß  (configuraci√≥n, setup, ajustes)
       - ‚ôªÔ∏è  (refactor)
       - üöÄ  (mejora de rendimiento, despliegue, optimizaci√≥n)
       - üì¶  (dependencias, paquetes, build)
    2. Luego deja una l√¨nea por medio y crea una lista con vi√±etas (m√°ximo 7 puntos) describiendo cambios m√°s espec√≠ficos:
       - Usa "-" como vi√±eta
       - S√© conciso, directo y en ingl√©s preferiblemente
       - No repitas el t√≠tulo, solo detalla
    3. Finalmente, deja una linea por medio e incluye la firma con este formato exacto:
       Changes made by Remberto Aguilar.
    Ejemplo:
    ‚ú® Enhance AutoMapper and nullable handling in controllers

    - Refactored ApiScopesController to handle nullable search parameters
    - Improved ApplicationDependencyInjection with dynamic profile registration
    - Removed PersistedGrantMapperProfile and centralized mapping logic
    - Updated PersistedGrantMappers to align with new mapping structure
    - Adjusted namespaces and dependencies for better maintainability
    
    Changes made by Remberto Aguilar.

code_generation:
  instructions: |
    - Crear controladores heredando de ControllerBase con [ApiController] y [Route("api/v{version:apiVersion}/[controller]")].
    - Incluir Summary XML-docs en clases p√∫blicas/m√©todos de API.
    - Endpoints devuelven ActionResult<T> y usan Results/ProblemDetails en errores.
    - Para DTOs usar record sealed; mapear con AutoMapper (perfiles por agregado).
    - Validaciones con FluentValidation y pipeline behavior en MediatR.
    - Servicios y casos de uso como clases internal sealed con primary constructor.
    - Excepciones de dominio espec√≠ficas; nunca exponer mensajes internos.
    - Middleware de excepciones, correlaci√≥n, logging y validaci√≥n.
    - Health checks en /health y readiness en /health/ready.
    - Respuestas cacheables con [ResponseCache] o IMemoryCache/DistributedCache donde aplique.

refactor_requests:
  instructions: |
    - Sugerir refactors seguros (extracci√≥n de m√©todos, inmutabilidad, early returns, pattern matching).
    - Introducir interfaces s√≥lo si hay dos implementaciones o claro beneficio testable.
    - Migrar switch anidados a switch expressions cuando mejore legibilidad.
    - Reducir par√°metros con records/options; aplicar SRP.

testing:
  instructions: |
    - Unit tests: xUnit + FluentAssertions + NSubstitute/Moq.
    - Integration tests: WebApplicationFactory, testcontainers (SQL Server/PG) o EFCore InMemory s√≥lo para escenarios controlados.
    - Nombrado: MethodName_ShouldExpectedBehavior_WhenCondition.
    - Cubrir: validadores, handlers MediatR, mapeos AutoMapper (AssertConfigurationIsValid), repositorios.
    - Usar Bogus para datos; AutoFixture opcional.

ef_core:
  instructions: |
    - Configurar entidades con TypeConfigurations separados por archivo.
    - Usar Guid como PK, generated by client/server seg√∫n estrategia.
    - Concurrencia con RowVersion cuando aplique.
    - No filtrar soft delete en consultas sin QueryFilters.
    - Migrations en proyecto dedicado; nombrar descriptivo; no editar a mano salvo necesidad.
    - Consultas as√≠ncronas y `AsNoTracking` en lecturas.

observability:
  instructions: |
    - Serilog con Enrich.FromLogContext y enricher de correlation-id.
    - LogLevel: Information por defecto; Debug/Verbose solo en Dev.
    - Estructurar logs (no cadenas concatenadas).
    - Opcional: OpenTelemetry (traces/metrics) si est√° habilitado.

security:
  instructions: |
    - Requerir HTTPS. HSTS en Prod.
    - Sanitizar entradas; no interpolar SQL.
    - No exponer stack traces en Prod.
    - Policies finas por recurso/acci√≥n; Authorize por defecto.

api_surface:
  instructions: |
    - Habilitar API Versioning (media type o URL).
    - Swagger/Swashbuckle con esquema de seguridad JWT (Bearer).
    - ProblemDetails RFC7807 para errores; 400s con detalle de validaci√≥n.
    - CORS por entorno (or√≠genes expl√≠citos).

prompts:
  examples: |
    - "Create a v1 controller for Books with CRUD, FluentValidation, AutoMapper, and ProblemDetails-ready error handling."
    - "Generate a MediatR command/handler to CreateBook with unit tests and validator."
    - "Add Serilog + Seq sink with IOptions-bound configuration and environment-based overrides."
    - "Introduce HealthChecks for DB and an external URL; wire endpoints /health and /health/ready."
