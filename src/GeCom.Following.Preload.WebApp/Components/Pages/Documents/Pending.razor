@page "/documents/pending"
@rendermode InteractiveServer
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@using Microsoft.AspNetCore.Components.Forms

<PageTitle>Documents</PageTitle>

<Topbar title="Documentos" />

@if (_isLoading)
{
    <div class="text-center py-2">
        <button class="btn btn-primary" type="button" disabled>
            <span class="spinner-border spinner-border-sm me-1" role="status"
                  aria-hidden="true"></span>
            Cargando datos....
        </button>
    </div>
}

<!-- Documents Tabs -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                @if (_isDataTableLoading)
                {
                    <div class="text-center py-2">
                        <button class="btn btn-primary" type="button" disabled>
                            <span class="spinner-border spinner-border-sm me-1" role="status"
                                  aria-hidden="true"></span>
                            Cargando datos...
                        </button>
                    </div>
                }
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <ul class="nav nav-tabs" id="documentsTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active text-danger" id="pending-documents-tab" data-bs-toggle="tab" data-bs-target="#pendingDocuments" type="button" role="tab" aria-controls="pendingDocuments" aria-selected="true">
                                <i class="ri-time-line"></i> Documentos Pendientes
                            </button>
                        </li>
                    </ul>
                    @if (!_hasReadOnlyRole)
                    {
                        <button class="btn btn-soft-success" @onclick="CreateNewDocument" style="margin-top: 0;">
                            <i class="ri-add-line"></i> PRECARGAR
                        </button>
                    }
                </div>
                <div class="tab-content">
                    <!-- Tab Documentos Pendientes -->
                    <div class="tab-pane fade show active" id="pendingDocuments" role="tabpanel" aria-labelledby="pending-documents-tab">
                        <table id="pending-documents-datatable" class="table table-striped w-100 nowrap">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th>Estado</th>
                                    <th>Cliente</th>
                                    @if (!_isProvider)
                                    {
                                        <th>Proveedor</th>
                                    }
                                    <th>Tipo Comprobante</th>
                                    <th>Punto de venta</th>
                                    <th>Número Comprobante</th>
                                    <th>Fecha Emisión</th>
                                    <th>Fecha Creación</th>
                                    <th>Moneda</th>
                                    <th>Monto Bruto Facturado</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var doc in _pendingDocuments)
                                {
                                    <tr>
                                        <td class="text-start align-middle p-0">
                                            <div class="d-flex gap-1 justify-content-start">
                                                <button type="button"
                                                        class="btn btn-primary btn-sm p-0"
                                                        style="width: 24px; height: 24px; line-height: 1;"
                                                        @onclick="@(() => OpenDocumentDetails(doc.DocId))"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#detailed-document-modal"
                                                        title="Ver detalles">
                                                    <i class="ri-eye-fill" style="font-size: 1rem; vertical-align: middle;"></i>
                                                </button>
                                                @if (!_hasReadOnlyRole)
                                                {
                                                    <button type="button"
                                                            class="btn btn-warning btn-sm p-0"
                                                            style="width: 24px; height: 24px; line-height: 1;"
                                                            @onclick="() => EditDocument(doc)"
                                                            title="Editar">
                                                        <i class="ri-edit-line" style="font-size: 1rem; vertical-align: middle;"></i>
                                                    </button>
                                                    @if (CanDeleteDocument(doc))
                                                    {
                                                        <button type="button"
                                                                class="btn btn-danger btn-sm p-0"
                                                                style="width: 24px; height: 24px; line-height: 1;"
                                                                @onclick="() => DeleteDocument(doc)"
                                                                title="Eliminar">
                                                            <i class="ri-delete-bin-line" style="font-size: 1rem; vertical-align: middle;"></i>
                                                        </button>
                                                    }
                                                }
                                            </div>
                                        </td>
                                        <td>
                                            <span class="@GetEstadoBadgeClass(doc.EstadoDescripcion)">
                                                @doc.EstadoDescripcion
                                            </span>
                                        </td>
                                        <td>@doc.SociedadDescripcion</td>
                                        @if (!_isProvider)
                                        {
                                            <td>@doc.ProveedorRazonSocial</td>
                                        }
                                        <td>@FormatDocumentType(doc)</td>
                                        <td>@doc.PuntoDeVenta</td>
                                        <td>@doc.NumeroComprobante</td>
                                        <td data-order="@(doc.FechaEmisionComprobante?.ToString("yyyy-MM-dd") ?? "")">
                                            @(doc.FechaEmisionComprobante?.ToString("dd/MM/yyyy"))
                                        </td>
                                        <td data-order="@(doc.FechaCreacion?.ToString("yyyy-MM-dd HH:mm:ss") ?? "")">
                                            @(doc.FechaCreacion?.ToString("dd/MM/yyyy HH:mm") ?? "")
                                        </td>
                                        <td>@doc.Moneda</td>
                                        <td>@(doc.MontoBruto?.ToString("N2"))</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- End Documents Tabs -->

<!-- Detailed Document - Modal -->
<div id="detailed-document-modal" class="modal fade" tabindex="-1" role="dialog"
     aria-labelledby="detailedDocumentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-full-width modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-white align-items-center rounded-top border-bottom">
                <h4 class="modal-title mb-0 d-flex align-items-center text-secondary" id="detailedDocumentModalLabel">
                    <i class="ri-file-text-line me-2"></i> Detalle de Documento
                </h4>
                <button type="button" class="btn-close ms-auto" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                @if (_isModalLoading)
                {
                    <div class="text-center py-2">
                        <button class="btn btn-primary" type="button" disabled>
                            <span class="spinner-border spinner-border-sm me-1" role="status"
                                  aria-hidden="true"></span>
                            Cargando datos...
                        </button>
                    </div>
                }
                else if (_selectedDocument is not null)
                {
                    <div class="row g-4">
                        <!-- Mitad izquierda: Datos del documento -->
                        <div class="col-md-6 border-end pe-4">
                            <div class="card shadow-sm mb-3 border border-primary-subtle">
                                <div class="card-header bg-primary-subtle">
                                    <h5 class="card-title mb-0">
                                        <span class="@GetEstadoBadgeClass(_selectedDocument.EstadoDescripcion) fs-6">@_selectedDocument.EstadoDescripcion</span>
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="fw-bold text-primary">Cliente / Razón Social</label>
                                            <div class="form-control-plaintext bg-light rounded w-auto px-2">@_selectedDocument.SociedadCuit - @_selectedDocument.SociedadDescripcion</div>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="fw-bold text-primary">Proveedor</label>
                                            <div class="form-control-plaintext bg-light rounded w-auto px-2">@_selectedDocument.ProveedorCuit - @_selectedDocument.ProveedorRazonSocial</div>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="fw-bold text-primary">Tipo de Documento</label>
                                            <div class="form-control-plaintext bg-light rounded w-auto px-2">@FormatDocumentType(_selectedDocument)</div>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="fw-bold text-primary">Punto de Venta</label>
                                            <div class="form-control-plaintext bg-light rounded w-auto px-2">@_selectedDocument.PuntoDeVenta</div>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="fw-bold text-primary">Nro. Comprobante</label>
                                            <div class="form-control-plaintext bg-light rounded w-auto px-2">@_selectedDocument.NumeroComprobante</div>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="fw-bold text-primary">Fecha Factura</label>
                                            <div class="form-control-plaintext bg-light rounded w-auto px-2">@(_selectedDocument.FechaEmisionComprobante?.ToString("dd/MM/yyyy"))</div>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="fw-bold text-primary">Moneda</label>
                                            <div class="form-control-plaintext bg-light rounded w-auto px-2">@_selectedDocument.Moneda</div>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="fw-bold text-primary">Importe Total</label>
                                            <div class="form-control-plaintext bg-light rounded w-auto px-2">@(_selectedDocument.MontoBruto?.ToString("N2"))</div>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="fw-bold text-primary">Nro. CAE / CAI</label>
                                            <div class="form-control-plaintext bg-light rounded w-auto px-2">@_selectedDocument.Caecai</div>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="fw-bold text-primary">Venc. CAE / CAI</label>
                                            <div class="form-control-plaintext bg-light rounded w-auto px-2">@(_selectedDocument.VencimientoCaecai?.ToString("dd/MM/yyyy"))</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            @if (IsPendingPreloadStatus(_selectedDocument))
                            {
                                <div class="alert alert-info mb-0">
                                    <i class="ri-information-line me-2"></i>
                                    <strong>Información:</strong> Solo podrá ver órdenes de compra y notas cuando el documento no esté en estado "Pendiente Precarga".
                                </div>
                            }
                            else
                            {
                                <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="oc-tab" data-bs-toggle="tab" data-bs-target="#ordenesCompra" type="button" role="tab" aria-controls="ordenesCompra" aria-selected="true">
                                            <i class="ri-shopping-cart-line"></i> Ordenes de Compra
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="comentarios-tab" data-bs-toggle="tab" data-bs-target="#comentarios" type="button" role="tab" aria-controls="comentarios" aria-selected="false">
                                            <i class="ri-chat-1-line"></i> Comentarios
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="notas-tab" data-bs-toggle="tab" data-bs-target="#notas" type="button" role="tab" aria-controls="notas" aria-selected="false">
                                            <i class="ri-sticky-note-line"></i> Notas
                                        </button>
                                    </li>
                                </ul>
                                <div class="tab-content">
                                    <div class="tab-pane fade show active" id="ordenesCompra" role="tabpanel" aria-labelledby="oc-tab">
                                        @if (_selectedDocument is not null && _selectedDocument.PurchaseOrders.Any())
                                        {
                                            <div>
                                                <table id="document-oc-datatable" class="table table-striped w-100 nowrap">
                                                    <thead>
                                                        <tr>
                                                            <th>Número OC</th>
                                                            <th>Posición</th>
                                                            <th>Código Recepción</th>
                                                            <th>Cantidad a Facturar</th>
                                                            <th>Código Sociedad FI</th>
                                                            <th>Proveedor SAP</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        @foreach (var po in _selectedDocument.PurchaseOrders)
                                                        {
                                                            <tr>
                                                                <td>@po.NroOc</td>
                                                                <td>@po.PosicionOc</td>
                                                                <td>@po.CodigoRecepcion</td>
                                                                <td>@po.CantidadAfacturar.ToString("N2")</td>
                                                                <td>@po.CodigoSociedadFi</td>
                                                                <td>@po.ProveedorSap</td>
                                                            </tr>
                                                        }
                                                    </tbody>
                                                </table>
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="alert alert-info mb-0">
                                                <i class="ri-information-line me-2"></i>No hay órdenes de compra asociadas a este documento.
                                            </div>
                                        }
                                    </div>
                                    <div class="tab-pane fade" id="comentarios" role="tabpanel" aria-labelledby="comentarios-tab">
                                        <div class="alert alert-info mb-0">
                                            <i class="ri-information-line me-2"></i>No hay comentarios disponibles.
                                        </div>
                                    </div>
                                    <div class="tab-pane fade" id="notas" role="tabpanel" aria-labelledby="notas-tab">
                                        @if (_selectedDocument is not null && _selectedDocument.Notes.Any())
                                        {
                                            <div>
                                                <table id="document-notes-datatable" class="table table-striped w-100 nowrap">
                                                    <thead>
                                                        <tr>
                                                            <th>Usuario</th>
                                                            <th>Fecha</th>
                                                            <th>Observaciones</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        @foreach (var note in _selectedDocument.Notes)
                                                        {
                                                            <tr>
                                                                <td>@note.UsuarioCreacion</td>
                                                                <td>@note.FechaCreacion.ToString("dd/MM/yyyy")</td>
                                                                <td>@note.Descripcion</td>
                                                            </tr>
                                                        }
                                                    </tbody>
                                                </table>
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="alert alert-info mb-0">
                                                <i class="ri-information-line me-2"></i>No hay notas disponibles.
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                        <!-- Mitad derecha: Visualización de PDF -->
                        <div class="col-md-6 ps-4">
                            <div class="card shadow-sm border border-info-subtle">
                                <div class="card-header bg-info-subtle">
                                    <h5 class="card-title mb-0">
                                        <i class="ri-file-pdf-line me-2"></i> PDF del Documento
                                    </h5>
                                </div>
                                <div class="card-body">
                                    @if (HasAttachment())
                                    {
                                        <PdfViewer AdjuntoId="@GetFirstAttachmentId()" OnError="HandlePdfError" />
                                    }
                                    else
                                    {
                                        <div class="mb-3">
                                            <label for="pdfFileDetail" class="form-label fw-bold">Seleccionar archivo PDF</label>
                                            <InputFile OnChange="HandlePdfFileSelected" class="form-control" id="pdfFileDetail" accept=".pdf,application/pdf" />
                                            <div class="form-text">Tamaño máximo: 6 MB. Solo archivos PDF.</div>
                                        </div>
                                        <div class="d-flex justify-content-center align-items-center border rounded p-4 bg-light" style="min-height: 300px;">
                                            <div class="text-center text-muted">
                                                <i class="ri-file-upload-line" style="font-size: 3rem;"></i>
                                                <p class="mt-2 mb-0">Arrastre y suelte el PDF aquí<br />o haga clic para seleccionar</p>
                                            </div>
                                        </div>
                                        @if (!string.IsNullOrWhiteSpace(_selectedPdfFileName))
                                        {
                                            <div class="mt-3">
                                                <div class="alert alert-success d-flex align-items-center" role="alert">
                                                    <i class="ri-checkbox-circle-line me-2"></i>
                                                    <div>
                                                        <strong>Archivo seleccionado:</strong> @_selectedPdfFileName
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">
                    <i class="ri-close-line me-1"></i>Cerrar
                </button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div> <!--end /.modal -->
<!-- End Detailed Document - Modal -->

<!-- Edit Document - Modal -->
<div id="edit-document-modal" class="modal fade" tabindex="-1" role="dialog"
     aria-labelledby="editDocumentModalLabel" aria-hidden="true"
     @onclick:stopPropagation="true">
    <div class="modal-dialog modal-full-width modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-white align-items-center rounded-top border-bottom">
                <h4 class="modal-title mb-0 d-flex align-items-center text-secondary" id="editDocumentModalLabel">
                    <i class="ri-edit-line me-2"></i> Editar Documento
                </h4>
                <button type="button" class="btn-close ms-auto" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                @if (_isModalLoading)
                {
                    <div class="text-center py-2">
                        <button class="btn btn-primary" type="button" disabled>
                            <span class="spinner-border spinner-border-sm me-1" role="status"
                                  aria-hidden="true"></span>
                            Cargando datos...
                        </button>
                    </div>
                }
                else if (_selectedDocument is not null)
                {
                    <div class="row g-4">
                        <!-- Mitad izquierda: Wizard de edición -->
                        <div class="col-md-6 border-end pe-4">
                            <div id="edit-document-wizard">
                                    <ul class="nav nav-pills nav-justified form-wizard-header mb-3">
                                        <li class="nav-item" data-target-form="#documentPropertiesForm">
                                            <a href="#document-properties-step" data-bs-toggle="tab" data-toggle="tab"
                                                class="nav-link rounded-0 py-2">
                                                <i class="ri-file-text-line fs-18 align-middle me-1"></i>
                                                <span class="d-none d-sm-inline">Propiedades</span>
                                            </a>
                                        </li>
                                        <li class="nav-item" data-target-form="#purchaseOrdersForm">
                                            <a href="#purchase-orders-step" data-bs-toggle="tab" data-toggle="tab"
                                                class="nav-link rounded-0 py-2 @(IsPendingPreloadStatus(_selectedDocument) ? "disabled" : "")"
                                                @onclick:preventDefault="@IsPendingPreloadStatus(_selectedDocument)"
                                                style="@(IsPendingPreloadStatus(_selectedDocument) ? "pointer-events: none; opacity: 0.5; cursor: not-allowed;" : "")">
                                                <i class="ri-shopping-cart-line fs-18 align-middle me-1"></i>
                                                <span class="d-none d-sm-inline">Órdenes de Compra</span>
                                            </a>
                                        </li>
                                        <li class="nav-item" data-target-form="#notesForm">
                                            <a href="#notes-step" data-bs-toggle="tab" data-toggle="tab"
                                                class="nav-link rounded-0 py-2 @(IsPendingPreloadStatus(_selectedDocument) ? "disabled" : "")"
                                                @onclick:preventDefault="@IsPendingPreloadStatus(_selectedDocument)"
                                                style="@(IsPendingPreloadStatus(_selectedDocument) ? "pointer-events: none; opacity: 0.5; cursor: not-allowed;" : "")">
                                                <i class="ri-sticky-note-line fs-18 align-middle me-1"></i>
                                                <span class="d-none d-sm-inline">Notas</span>
                                            </a>
                                        </li>
                                    </ul>

                                    <div class="tab-content">
                                        <!-- Paso 1: Propiedades del Documento -->
                                        <div class="tab-pane" id="document-properties-step">
                                            @if (IsPendingPreloadStatus(_selectedDocument))
                                            {
                                                <div id="first-tab-warning-alert" class="alert alert-warning mb-3">
                                                    <i class="ri-alert-line me-2"></i>
                                                    <strong>Atención:</strong> Debe completar todos los campos de este paso antes de poder avanzar a los siguientes.
                                                </div>
                                            }
                                            <form id="documentPropertiesForm" method="post" action="#" class="form-horizontal needs-validation" novalidate>
                                                <div class="card shadow-sm mb-3 border border-primary-subtle">
                                                    <div class="card-header bg-primary-subtle">
                                                        <h5 class="card-title mb-0">
                                                            <span class="@GetEstadoBadgeClass(_selectedDocument.EstadoDescripcion) fs-6">@_selectedDocument.EstadoDescripcion</span>
                                                        </h5>
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="row g-3">
                                                            <div class="col-md-6">
                                                                <label class="fw-bold text-primary" for="society-select-edit">Cliente / Razón Social</label>
                                                                <select id="society-select-edit" 
                                                                        name="society-select-edit"
                                                                        class="form-control" 
                                                                        data-selected-value="@_selectedSocietyCuit"
                                                                        @onchange="OnSocietyChanged"
                                                                        required>
                                                                    <option value="">Seleccione un cliente</option>
                                                                    @foreach (var society in _societies)
                                                                    {
                                                                        <option value="@society.Cuit" selected="@(society.Cuit == _selectedSocietyCuit)">
                                                                            @society.Cuit - @(society.Descripcion ?? "Sin nombre")
                                                                        </option>
                                                                    }
                                                                    @* Add document's society if not in the list *@
                                                                    @if (_selectedDocument is not null && !string.IsNullOrWhiteSpace(_selectedDocument.SociedadCuit) && !_societies.Any(s => s.Cuit == _selectedDocument.SociedadCuit))
                                                                    {
                                                                        <option value="@_selectedDocument.SociedadCuit" selected="true">
                                                                            @_selectedDocument.SociedadCuit - @(_selectedDocument.SociedadDescripcion ?? "Sin nombre")
                                                                        </option>
                                                                    }
                                                                </select>
                                                                <div class="invalid-feedback">
                                                                    Por favor seleccione un cliente.
                                                                </div>
                                                            </div>
                                                            <div class="col-md-6">
                                                                <label class="fw-bold text-primary" for="provider-select-edit">Proveedor</label>
                                                                @if (_isProvider && !string.IsNullOrWhiteSpace(_providerCuit))
                                                                {
                                                                    @* Provider role: Show provider as read-only text *@
                                                                    <div class="form-control-plaintext bg-light rounded w-auto px-2">
                                                                        @if (_selectedDocument is not null)
                                                                        {
                                                                            @($"{_selectedDocument.ProveedorCuit} - {_selectedDocument.ProveedorRazonSocial}")
                                                                        }
                                                                        else if (!string.IsNullOrWhiteSpace(_providerCuit))
                                                                        {
                                                                            @_providerCuit
                                                                        }
                                                                        else
                                                                        {
                                                                            <span class="text-muted">No disponible</span>
                                                                        }
                                                                    </div>
                                                                }
                                                                else if (_isSociety && !string.IsNullOrWhiteSpace(_userEmail))
                                                                {
                                                                    @* Society role: Show provider as editable SELECT *@
                                                                    <select id="provider-select-edit" 
                                                                            name="provider-select-edit"
                                                                            class="form-control" 
                                                                            data-selected-value="@_selectedProviderCuit"
                                                                            @onchange="OnProviderChanged"
                                                                            required>
                                                                        <option value="">Seleccione un proveedor</option>
                                                                        @foreach (var provider in _availableProviders)
                                                                        {
                                                                            <option value="@provider.Cuit" selected="@(provider.Cuit == _selectedProviderCuit)">
                                                                                @provider.Cuit - @provider.RazonSocial
                                                                            </option>
                                                                        }
                                                                        @* Add document's provider if not in the list *@
                                                                        @if (_selectedDocument is not null && !string.IsNullOrWhiteSpace(_selectedDocument.ProveedorCuit) && !_availableProviders.Any(p => p.Cuit == _selectedDocument.ProveedorCuit))
                                                                        {
                                                                            <option value="@_selectedDocument.ProveedorCuit" selected="true">
                                                                                @_selectedDocument.ProveedorCuit - @(_selectedDocument.ProveedorRazonSocial ?? "Sin nombre")
                                                                            </option>
                                                                        }
                                                                    </select>
                                                                    <div class="invalid-feedback">
                                                                        Por favor seleccione un proveedor.
                                                                    </div>
                                                                }
                                                                else
                                                                {
                                                                    <div class="form-control-plaintext bg-light rounded w-auto px-2">
                                                                        @if (_selectedDocument is not null)
                                                                        {
                                                                            @($"{_selectedDocument.ProveedorCuit} - {_selectedDocument.ProveedorRazonSocial}")
                                                                        }
                                                                        else
                                                                        {
                                                                            <span class="text-muted">No disponible</span>
                                                                        }
                                                                    </div>
                                                                }
                                                            </div>
                                                            <div class="col-md-4">
                                                                <label class="fw-bold text-primary" for="document-type-select-edit">Tipo de Documento</label>
                                                                <select id="document-type-select-edit" 
                                                                        name="document-type-select-edit"
                                                                        class="form-control" 
                                                                        data-selected-value="@_selectedDocumentTypeId"
                                                                        @onchange="OnDocumentTypeChanged"
                                                                        required>
                                                                    <option value="">Seleccione un tipo de documento</option>
                                                                    @foreach (var docType in _documentTypes)
                                                                    {
                                                                        <option value="@docType.TipoDocId" selected="@(docType.TipoDocId == _selectedDocumentTypeId)">
                                                                            @docType.Codigo@(docType.Letra != null ? $" - {docType.Letra}" : "") - @docType.Descripcion
                                                                        </option>
                                                                    }
                                                                </select>
                                                                <div class="invalid-feedback">
                                                                    Por favor seleccione un tipo de documento.
                                                                </div>
                                                            </div>
                                                            <div class="col-md-4">
                                                                <label class="fw-bold text-primary" for="punto-venta-edit">Punto de Venta</label>
                                                                <input id="punto-venta-edit"
                                                                       name="punto-venta-edit"
                                                                       type="text" 
                                                                       class="form-control" 
                                                                       @bind="_selectedPuntoDeVenta"
                                                                       @bind:event="oninput"
                                                                       maxlength="5"
                                                                       pattern="[0-9]{1,5}"
                                                                       required>
                                                                <div class="invalid-feedback">
                                                                    Por favor ingrese el punto de venta.
                                                                </div>
                                                            </div>
                                                            <div class="col-md-4">
                                                                <label class="fw-bold text-primary" for="numero-comprobante-edit">Nro. Comprobante</label>
                                                                <input id="numero-comprobante-edit"
                                                                       name="numero-comprobante-edit"
                                                                       type="text" 
                                                                       class="form-control" 
                                                                       @bind="_selectedNumeroComprobante"
                                                                       @bind:event="oninput"
                                                                       maxlength="8"
                                                                       pattern="[0-9]{1,8}"
                                                                       required>
                                                                <div class="invalid-feedback">
                                                                    Por favor ingrese el número de comprobante.
                                                                </div>
                                                            </div>
                                                            <div class="col-md-4">
                                                                <label class="fw-bold text-primary" for="fecha-factura-edit">Fecha Factura</label>
                                                                <input id="fecha-factura-edit"
                                                                       name="fecha-factura-edit"
                                                                       type="text"
                                                                       class="form-control"
                                                                       data-provider="flatpickr"
                                                                       data-date-format="d/m/Y"
                                                                       data-allow-input="true"
                                                                       @bind="_selectedFechaFactura"
                                                                       required>
                                                                <div class="invalid-feedback">
                                                                    La fecha de factura no puede ser mayor al día actual.
                                                                </div>
                                                            </div>
                                                            <div class="col-md-4">
                                                                <label class="fw-bold text-primary" for="currency-select-edit">Moneda</label>
                                                                <select id="currency-select-edit" 
                                                                        name="currency-select-edit"
                                                                        class="form-control" 
                                                                        data-selected-value="@_selectedCurrencyCode"
                                                                        @onchange="OnCurrencyChanged"
                                                                        required>
                                                                    <option value="">Seleccione una moneda</option>
                                                                    @foreach (var currency in _currencies)
                                                                    {
                                                                        <option value="@currency.Codigo" selected="@(currency.Codigo == _selectedCurrencyCode)">
                                                                            @currency.Codigo - @currency.Descripcion
                                                                        </option>
                                                                    }
                                                                </select>
                                                                <div class="invalid-feedback">
                                                                    Por favor seleccione una moneda.
                                                                </div>
                                                            </div>
                                                            <div class="col-md-4">
                                                                <label class="fw-bold text-primary" for="monto-bruto-edit">Importe Total</label>
                                                                <input id="monto-bruto-edit"
                                                                       name="monto-bruto-edit"
                                                                       type="number" 
                                                                       step="0.01" 
                                                                       class="form-control" 
                                                                       @bind="_selectedMontoBruto"
                                                                       @bind:event="oninput"
                                                                       min="0.01"
                                                                       required>
                                                                <div class="invalid-feedback">
                                                                    Ingrese un importe válido mayor a cero.
                                                                </div>
                                                            </div>
                                                            <div class="col-md-6">
                                                                <label class="fw-bold text-primary" for="caecai-edit">Nro. CAE / CAI</label>
                                                                <input id="caecai-edit"
                                                                       name="caecai-edit"
                                                                       type="text" 
                                                                       class="form-control" 
                                                                       @bind="_selectedCaecai"
                                                                       @bind:event="oninput"
                                                                       maxlength="14"
                                                                       pattern="[0-9]{14}"
                                                                       required>
                                                                <div class="invalid-feedback">
                                                                    El nro. CAE/CAI debe tener exactamente 14 dígitos.
                                                                </div>
                                                            </div>
                                                            <div class="col-md-6">
                                                                <label class="fw-bold text-primary" for="venc-caecai-edit">Venc. CAE / CAI</label>
                                                                <input id="venc-caecai-edit"
                                                                       name="venc-caecai-edit"
                                                                       type="text"
                                                                       class="form-control"
                                                                       data-provider="flatpickr"
                                                                       data-date-format="d/m/Y"
                                                                       data-allow-input="true"
                                                                       @bind="_selectedVencimientoCaecai"
                                                                       required>
                                                                <div class="invalid-feedback">
                                                                    La fecha Venc. CAE/CAI no puede ser anterior a la fecha de factura.
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>

                                        <!-- Paso 2: Órdenes de Compra -->
                                        <div class="tab-pane fade" id="purchase-orders-step">
                                            <form id="purchaseOrdersForm" method="post" action="#" class="form-horizontal">
                                                <div class="card shadow-sm border border-info-subtle">
                                                    <div class="card-header bg-info-subtle">
                                                        <h5 class="card-title mb-0">
                                                            <i class="ri-shopping-cart-line me-2"></i> Órdenes de Compra
                                                        </h5>
                                                    </div>
                                                    <div class="card-body">
                                                        @if (IsPendingPreloadStatus(_selectedDocument))
                                                        {
                                                            <div class="alert alert-info mb-0">
                                                                <i class="ri-information-line me-2"></i>
                                                                <strong>Información:</strong> Solo podrá editar órdenes de compra cuando el documento no esté en estado "Pendiente Precarga".
                                                            </div>
                                                        }
                                                        else if (_isLoadingSapPurchaseOrders)
                                                        {
                                                            <div class="text-center py-4">
                                                                <div class="spinner-border text-primary" role="status">
                                                                    <span class="visually-hidden">Cargando órdenes de compra...</span>
                                                                </div>
                                                                <p class="mt-2 text-muted">Cargando órdenes de compra SAP...</p>
                                                            </div>
                                                        }
                                                        else if (_sapPurchaseOrders.Any())
                                                        {
                                                            <div>
                                                                <table id="edit-document-oc-datatable" class="table table-striped w-100 nowrap">
                                                                    <thead>
                                                                        <tr>
                                                                            <th style="width: 80px;">Acciones</th>
                                                                            <th>Nro. OC</th>
                                                                            <th>Posición</th>
                                                                            <th>Desc. Producto</th>
                                                                            <th>Cant. Falta Fact.</th>
                                                                            <th>Importe Unitario</th>
                                                                            <th>Cant. a Facturar</th>
                                                                            <th>Cod. Recepcion</th>
                                                                            <th>Neto Anticipo</th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody>
                                                                        @foreach (var po in _sapPurchaseOrders)
                                                                        {
                                                                            <tr>
                                                                                <td class="text-center align-middle">
                                                                                    <div class="d-flex gap-1 justify-content-center">
                                                                                        @if (po.CantidadAFacturar is null)
                                                                                        {
                                                                                            <button type="button"
                                                                                                    class="btn btn-success btn-sm p-0"
                                                                                                    style="width: 28px; height: 28px; line-height: 1;"
                                                                                                    @onclick="() => AddPurchaseOrder(po)"
                                                                                                    title="Agregar orden de compra">
                                                                                                <i class="ri-add-line" style="font-size: 1.1rem; vertical-align: middle;"></i>
                                                                                            </button>
                                                                                        }
                                                                                        else
                                                                                        {
                                                                                            <button type="button"
                                                                                                    class="btn btn-danger btn-sm p-0"
                                                                                                    style="width: 28px; height: 28px; line-height: 1;"
                                                                                                    @onclick="() => RemovePurchaseOrder(po)"
                                                                                                    title="Eliminar orden de compra">
                                                                                                <i class="ri-delete-bin-line" style="font-size: 1.1rem; vertical-align: middle;"></i>
                                                                                            </button>
                                                                                        }
                                                                                    </div>
                                                                                </td>
                                                                                <td>@po.Nrodocumento</td>
                                                                                <td>@po.Posicion</td>
                                                                                <td>@(po.Textobreve ?? "-")</td>
                                                                                <td>@(po.CantidadFaltaFacturar?.ToString("N2") ?? "-")</td>
                                                                                <td>@po.Importeoriginal.ToString("N2")</td>
                                                                                <td>@(po.CantidadAFacturar?.ToString("N2") ?? "-")</td>
                                                                                <td>@(po.CodigoRecepcion ?? "-")</td>
                                                                                <td>@(po.NetoAnticipo?.ToString("N2") ?? "-")</td>
                                                                            </tr>
                                                                        }
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        }
                                                        else
                                                        {
                                                            <div class="alert alert-info mb-0">
                                                                <i class="ri-information-line me-2"></i>No se encontraron órdenes de compra SAP para este documento.
                                                            </div>
                                                        }
                                                    </div>
                                                </div>
                                            </form>
                                        </div>

                                        <!-- Paso 3: Notas -->
                                        <div class="tab-pane fade" id="notes-step">
                                            <form id="notesForm" method="post" action="#" class="form-horizontal">
                                                <div class="card shadow-sm border border-success-subtle">
                                                    <div class="card-header bg-success-subtle">
                                                        <h5 class="card-title mb-0">
                                                            <i class="ri-sticky-note-line me-2"></i> Notas
                                                        </h5>
                                                    </div>
                                                    <div class="card-body">
                                                        @if (IsPendingPreloadStatus(_selectedDocument))
                                                        {
                                                            <div class="alert alert-info mb-0">
                                                                <i class="ri-information-line me-2"></i>
                                                                <strong>Información:</strong> Solo podrá editar notas cuando el documento no esté en estado "Pendiente Precarga".
                                                            </div>
                                                        }
                                                        else if (_selectedDocument is not null && _selectedDocument.Notes.Any())
                                                        {
                                                            <div>
                                                                <table id="edit-document-notes-datatable" class="table table-striped w-100 nowrap">
                                                                    <thead>
                                                                        <tr>
                                                                            <th>Usuario</th>
                                                                            <th>Fecha</th>
                                                                            <th>Observaciones</th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody>
                                                                        @foreach (var note in _selectedDocument.Notes)
                                                                        {
                                                                            <tr>
                                                                                <td>@note.UsuarioCreacion</td>
                                                                                <td>@note.FechaCreacion.ToString("dd/MM/yyyy")</td>
                                                                                <td>@note.Descripcion</td>
                                                                            </tr>
                                                                        }
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        }
                                                        else
                                                        {
                                                            <div class="alert alert-info mb-0">
                                                                <i class="ri-information-line me-2"></i>No hay notas disponibles.
                                                            </div>
                                                        }
                                                    </div>
                                                </div>
                                            </form>
                                        </div>

                                        <!-- Botones de navegación del wizard -->
                                        <div class="d-flex wizard justify-content-between flex-wrap gap-2 mt-3">
                                            <div class="first">
                                                <a href="javascript:void(0);" class="btn btn-primary">
                                                    Inicio
                                                </a>
                                            </div>
                                            <div class="d-flex flex-wrap gap-2">
                                                <div class="previous">
                                                    <a href="javascript:void(0);" class="btn btn-primary">
                                                        <i class="ri-arrow-left-line me-2"></i>Anterior
                                                    </a>
                                                </div>
                                                <div class="next">
                                                    <a href="javascript:void(0);" class="btn btn-primary mt-3 mt-md-0">
                                                        Siguiente<i class="ri-arrow-right-line ms-2"></i>
                                                    </a>
                                                </div>
                                            </div>
                                            <div class="last" style="display: none;">
                                                <a href="javascript:void(0);" class="btn btn-success mt-3 mt-md-0">
                                                    <i class="ri-save-line me-1"></i>Enviar a Mesa
                                                </a>
                                            </div>
                                        </div>
                                    </div> <!-- tab-content -->
                                </div> <!-- end #edit-document-wizard-->
                        </div>
                        <!-- Mitad derecha: Visualización de PDF -->
                        <div class="col-md-6 ps-4">
                            <div class="card shadow-sm border border-info-subtle">
                                <div class="card-header bg-info-subtle d-flex justify-content-between align-items-center">
                                    <h5 class="card-title mb-0">
                                        <i class="ri-file-pdf-line me-2"></i> PDF del Documento
                                    </h5>
                                    <div>
                                        <button type="button" class="btn btn-primary btn-sm" @onclick="TriggerPdfFileInputClickAsync" disabled="@_isUpdatingPdf">
                                            @if (_isUpdatingPdf)
                                            {
                                                <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                                                <span>Actualizando...</span>
                                            }
                                            else
                                            {
                                                <i class="ri-file-edit-line me-1"></i>
                                                <span>Modificar Archivo</span>
                                            }
                                        </button>
                                        <InputFile OnChange="HandlePdfFileSelectedForUpdate" class="d-none" id="pdfFileUpdateInput" accept=".pdf,application/pdf" />
                                    </div>
                                </div>
                                <div class="card-body">
                                    @if (!string.IsNullOrWhiteSpace(_pdfUpdateErrorMessage))
                                    {
                                        <div class="alert alert-danger alert-dismissible fade show mb-3" role="alert">
                                            <i class="ri-error-warning-line me-2"></i>@_pdfUpdateErrorMessage
                                            <button type="button" class="btn-close" @onclick="() => _pdfUpdateErrorMessage = string.Empty" aria-label="Close"></button>
                                        </div>
                                    }
                                    @if (_selectedPdfFileForUpdate is not null)
                                    {
                                        <div class="alert alert-info d-flex align-items-center mb-3" role="alert">
                                            <i class="ri-file-pdf-line me-2"></i>
                                            <div class="flex-grow-1">
                                                <strong>Archivo seleccionado:</strong> @_selectedPdfFileForUpdate.Name
                                            </div>
                                            <button type="button" class="btn btn-success btn-sm ms-2" @onclick="HandlePdfUpdateAsync" disabled="@_isUpdatingPdf">
                                                <i class="ri-upload-cloud-line me-1"></i>Subir
                                            </button>
                                        </div>
                                    }
                                    @if (HasAttachment())
                                    {
                                        <PdfViewer AdjuntoId="@GetFirstAttachmentId()" OnError="HandlePdfError" />
                                    }
                                    else
                                    {
                                        <div class="mb-3">
                                            <label for="pdfFileEdit" class="form-label fw-bold">Seleccionar archivo PDF</label>
                                            <InputFile OnChange="HandlePdfFileSelected" class="form-control" id="pdfFileEdit" accept=".pdf,application/pdf" />
                                            <div class="form-text">Tamaño máximo: 6 MB. Solo archivos PDF.</div>
                                        </div>
                                        <div class="d-flex justify-content-center align-items-center border rounded p-4 bg-light" style="min-height: 300px;">
                                            <div class="text-center text-muted">
                                                <i class="ri-file-upload-line" style="font-size: 3rem;"></i>
                                                <p class="mt-2 mb-0">Arrastre y suelte el PDF aquí<br />o haga clic para seleccionar</p>
                                            </div>
                                        </div>
                                        @if (!string.IsNullOrWhiteSpace(_selectedPdfFileName))
                                        {
                                            <div class="mt-3">
                                                <div class="alert alert-success d-flex align-items-center" role="alert">
                                                    <i class="ri-checkbox-circle-line me-2"></i>
                                                    <div>
                                                        <strong>Archivo seleccionado:</strong> @_selectedPdfFileName
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" @onclick="CleanupCurrencySelect2">
                    <i class="ri-close-line me-1"></i>Cerrar
                </button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div> <!--end /.modal -->
<!-- End Edit Document - Modal -->

<!-- Toast Component -->
<Toast @ref="_toast" ToastId="pending-toast" />
<!-- End Toast Component -->

<!-- Preload Document - Modal -->
<PreloadDocumentModal @ref="_preloadModal" OnDocumentPreloaded="OnDocumentPreloaded" OnCancel="() => Task.CompletedTask" />
<!-- End Preload Document - Modal -->