@page "/documents/{DocId:int}/edit"
@rendermode InteractiveServer
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@using Microsoft.AspNetCore.Components.Forms

<PageTitle>Documents</PageTitle>

<Topbar title="Editar Documento" />

@if (_isLoading)
{
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-3">Cargando información del documento...</p>
    </div>
}
else if (_selectedDocument is null)
{
    <div class="alert alert-danger" role="alert">
        <h4 class="alert-heading">Documento no encontrado</h4>
        <p>No se pudo encontrar el documento con ID: @DocId</p>
        <hr>
        <button class="btn btn-primary" @onclick="NavigateToDocuments">
            <i class="ri-arrow-left-line me-1"></i> Volver a Documentos
        </button>
    </div>
}
else
{
    <!-- Document Edit Tab -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body p-0">
                    <div class="d-flex justify-content-between align-items-start mb-3 px-4 pt-4">
                        <ul class="nav nav-tabs" id="editDocumentTab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active text-danger" id="edit-document-tab" data-bs-toggle="tab" data-bs-target="#editDocumentContent" type="button" role="tab" aria-controls="editDocumentContent" aria-selected="true">
                                    <i class="ri-edit-line"></i> Editar Documento
                                </button>
                            </li>
                        </ul>
                        <button class="btn btn-soft-primary" @onclick="NavigateToDocuments" style="margin-top: 0;">
                            <i class="ri-arrow-left-line me-1"></i> Volver
                        </button>
                    </div>
                    <div class="tab-content px-4 pb-4">
                        <!-- Tab Editar Documento -->
                        <div class="tab-pane fade show active" id="editDocumentContent" role="tabpanel" aria-labelledby="edit-document-tab">
                            <div class="row g-4">
                                <!-- Mitad izquierda: Wizard de edición -->
                                <div class="col-md-6 border-end pe-4">
                                    <div id="edit-document-wizard">
                                        <ul class="nav nav-pills nav-justified form-wizard-header mb-3">
                                            <li class="nav-item" data-target-form="#documentPropertiesForm">
                                                <a href="#document-properties-step" data-bs-toggle="tab" data-toggle="tab"
                                                   class="nav-link rounded-0 py-2">
                                                    <i class="ri-file-text-line fs-18 align-middle me-1"></i>
                                                    <span class="d-none d-sm-inline">Propiedades</span>
                                                </a>
                                            </li>
                                            <li class="nav-item" data-target-form="#purchaseOrdersForm">
                                                <a href="#purchase-orders-step" data-bs-toggle="tab" data-toggle="tab"
                                                   class="nav-link rounded-0 py-2 @(IsPendingPreloadStatus(_selectedDocument) ? "disabled" : "")"
                                                   @onclick:preventDefault="@IsPendingPreloadStatus(_selectedDocument)"
                                                   style="@(IsPendingPreloadStatus(_selectedDocument) ? "pointer-events: none; opacity: 0.5; cursor: not-allowed" : string.Empty)">
                                                    <i class="ri-shopping-cart-line fs-18 align-middle me-1"></i>
                                                    <span class="d-none d-sm-inline">Órdenes de Compra</span>
                                                </a>
                                            </li>
                                            <li class="nav-item" data-target-form="#notesForm">
                                                <a href="#notes-step" data-bs-toggle="tab" data-toggle="tab"
                                                   class="nav-link rounded-0 py-2 @(IsPendingPreloadStatus(_selectedDocument) ? "disabled" : "")"
                                                   @onclick:preventDefault="@IsPendingPreloadStatus(_selectedDocument)"
                                                   style="@(IsPendingPreloadStatus(_selectedDocument) ? "pointer-events: none; opacity: 0.5; cursor: not-allowed" : string.Empty)">
                                                    <i class="ri-sticky-note-line fs-18 align-middle me-1"></i>
                                                    <span class="d-none d-sm-inline">Notas</span>
                                                </a>
                                            </li>
                                        </ul>

                                        <div class="tab-content">
                                            <!-- Paso 1: Propiedades del Documento -->
                                            <div class="tab-pane" id="document-properties-step">
                                                @if (IsPendingPreloadStatus(_selectedDocument))
                                                {
                                                    <div id="first-tab-warning-alert" class="alert alert-warning mb-3">
                                                        <i class="ri-alert-line me-2"></i>
                                                        <strong>Atención:</strong> Debe completar todos los campos de este paso antes de poder avanzar a los siguientes.
                                                    </div>
                                                }
                                                <form id="documentPropertiesForm" method="post" action="#" class="form-horizontal needs-validation" novalidate>
                                                    <div class="card shadow-sm mb-3 border border-primary-subtle">
                                                        <div class="card-header bg-primary-subtle">
                                                            <h5 class="card-title mb-0">
                                                                <span class="@GetEstadoBadgeClass(_selectedDocument.EstadoDescripcion) fs-6">@_selectedDocument.EstadoDescripcion</span>
                                                            </h5>
                                                        </div>
                                                        <div class="card-body">
                                                            <div class="row g-3">
                                                                <div class="col-md-6">
                                                                    <label class="fw-bold text-primary" for="society-select-edit">Cliente / Razón Social</label>
                                                                    @if (_isProvider && !string.IsNullOrWhiteSpace(_providerCuit))
                                                                    {
                                                                        <select id="society-select-edit"
                                                                                name="society-select-edit"
                                                                                class="form-control"
                                                                                data-selected-value="@_selectedSocietyCuit"
                                                                                @onchange="OnSocietyChanged"
                                                                                required>
                                                                            <option value="">Seleccione un cliente</option>
                                                                            @foreach (var society in _providerSocieties)
                                                                            {
                                                                                <option value="@society.Cuit" selected="@(society.Cuit == _selectedSocietyCuit)">
                                                                                    @society.Cuit - @(society.Name ?? "Sin nombre")
                                                                                </option>
                                                                            }
                                                                        </select>
                                                                        <div class="invalid-feedback">
                                                                            Por favor seleccione un cliente.
                                                                        </div>
                                                                    }
                                                                    else
                                                                    {
                                                                        <div class="form-control-plaintext bg-light rounded w-auto px-2">@_selectedDocument.SociedadCuit - @_selectedDocument.SociedadDescripcion</div>
                                                                    }
                                                                </div>
                                                                <div class="col-md-6">
                                                                    <label class="fw-bold text-primary">Proveedor</label>
                                                                    <div class="form-control-plaintext bg-light rounded w-auto px-2">@_selectedDocument.ProveedorCuit - @_selectedDocument.ProveedorRazonSocial</div>
                                                                </div>
                                                                <div class="col-md-4">
                                                                    <label class="fw-bold text-primary" for="document-type-select-edit">Tipo de Documento</label>
                                                                    <select id="document-type-select-edit"
                                                                            name="document-type-select-edit"
                                                                            class="form-control"
                                                                            data-selected-value="@_selectedDocumentTypeId"
                                                                            @onchange="OnDocumentTypeChanged"
                                                                            required>
                                                                        <option value="">Seleccione un tipo de documento</option>
                                                                        @foreach (var docType in _documentTypes)
                                                                        {
                                                                            <option value="@docType.TipoDocId" selected="@(docType.TipoDocId == _selectedDocumentTypeId)">
                                                                                @docType.Codigo@(docType.Letra != null ? $" - {docType.Letra}" : "") - @docType.Descripcion
                                                                            </option>
                                                                        }
                                                                    </select>
                                                                    <div class="invalid-feedback">
                                                                        Por favor seleccione un tipo de documento.
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-4">
                                                                    <label class="fw-bold text-primary" for="punto-venta-edit">Punto de Venta</label>
                                                                    <input id="punto-venta-edit"
                                                                           name="punto-venta-edit"
                                                                           type="text"
                                                                           class="form-control"
                                                                           @bind="_selectedPuntoDeVenta"
                                                                           @bind:event="oninput"
                                                                           maxlength="5"
                                                                           pattern="[0-9]{1,5}"
                                                                           required>
                                                                    <div class="invalid-feedback">
                                                                        Por favor ingrese el punto de venta.
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-4">
                                                                    <label class="fw-bold text-primary" for="numero-comprobante-edit">Nro. Comprobante</label>
                                                                    <input id="numero-comprobante-edit"
                                                                           name="numero-comprobante-edit"
                                                                           type="text"
                                                                           class="form-control"
                                                                           @bind="_selectedNumeroComprobante"
                                                                           @bind:event="oninput"
                                                                           maxlength="8"
                                                                           pattern="[0-9]{1,8}"
                                                                           required>
                                                                    <div class="invalid-feedback">
                                                                        Por favor ingrese el número de comprobante.
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-4">
                                                                    <label class="fw-bold text-primary" for="fecha-factura-edit">Fecha Factura</label>
                                                                    <input id="fecha-factura-edit"
                                                                           name="fecha-factura-edit"
                                                                           type="text"
                                                                           class="form-control"
                                                                           data-provider="flatpickr"
                                                                           data-date-format="d/m/Y"
                                                                           data-allow-input="true"
                                                                           @bind="_selectedFechaFactura"
                                                                           required>
                                                                    <div class="invalid-feedback">
                                                                        La fecha de factura no puede ser mayor al día actual.
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-4">
                                                                    <label class="fw-bold text-primary" for="currency-select-edit">Moneda</label>
                                                                    <select id="currency-select-edit"
                                                                            name="currency-select-edit"
                                                                            class="form-control"
                                                                            data-selected-value="@_selectedCurrencyCode"
                                                                            @onchange="OnCurrencyChanged"
                                                                            required>
                                                                        <option value="">Seleccione una moneda</option>
                                                                        @foreach (var currency in _currencies)
                                                                        {
                                                                            <option value="@currency.Codigo" selected="@(currency.Codigo == _selectedCurrencyCode)">
                                                                                @currency.Codigo - @currency.Descripcion
                                                                            </option>
                                                                        }
                                                                    </select>
                                                                    <div class="invalid-feedback">
                                                                        Por favor seleccione una moneda.
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-4">
                                                                    <label class="fw-bold text-primary" for="monto-bruto-edit">Importe Total</label>
                                                                    <input id="monto-bruto-edit"
                                                                           name="monto-bruto-edit"
                                                                           type="number"
                                                                           step="0.01"
                                                                           class="form-control"
                                                                           @bind="_selectedMontoBruto"
                                                                           @bind:event="oninput"
                                                                           min="0.01"
                                                                           required>
                                                                    <div class="invalid-feedback">
                                                                        Ingrese un importe válido mayor a cero.
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-6">
                                                                    <label class="fw-bold text-primary" for="caecai-edit">Nro. CAE / CAI</label>
                                                                    <input id="caecai-edit"
                                                                           name="caecai-edit"
                                                                           type="text"
                                                                           class="form-control"
                                                                           @bind="_selectedCaecai"
                                                                           @bind:event="oninput"
                                                                           maxlength="14"
                                                                           pattern="[0-9]{14}"
                                                                           required>
                                                                    <div class="invalid-feedback">
                                                                        El nro. CAE/CAI debe tener exactamente 14 dígitos.
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-6">
                                                                    <label class="fw-bold text-primary" for="venc-caecai-edit">Venc. CAE / CAI</label>
                                                                    <input id="venc-caecai-edit"
                                                                           name="venc-caecai-edit"
                                                                           type="text"
                                                                           class="form-control"
                                                                           data-provider="flatpickr"
                                                                           data-date-format="d/m/Y"
                                                                           data-allow-input="true"
                                                                           @bind="_selectedVencimientoCaecai"
                                                                           required>
                                                                    <div class="invalid-feedback">
                                                                        La fecha Venc. CAE/CAI no puede ser anterior a la fecha de factura.
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </form>
                                            </div>

                                            <!-- Paso 2: Órdenes de Compra -->
                                            <div class="tab-pane fade" id="purchase-orders-step">
                                                <form id="purchaseOrdersForm" method="post" action="#" class="form-horizontal">
                                                    <div class="card shadow-sm border border-info-subtle">
                                                        <div class="card-header bg-info-subtle">
                                                            <h5 class="card-title mb-0">
                                                                <i class="ri-shopping-cart-line me-2"></i> Órdenes de Compra
                                                            </h5>
                                                        </div>
                                                        <div class="card-body">
                                                            @if (IsPendingPreloadStatus(_selectedDocument))
                                                            {
                                                                <div class="alert alert-info mb-0">
                                                                    <i class="ri-information-line me-2"></i>
                                                                    <strong>Información:</strong> Solo podrá editar órdenes de compra cuando el documento no esté en estado "Pendiente Precarga".
                                                                </div>
                                                            }
                                                            else if (_selectedDocument.PurchaseOrders.Any())
                                                            {
                                                                <div>
                                                                    <table id="edit-document-oc-datatable" class="table table-striped w-100 nowrap">
                                                                        <thead>
                                                                            <tr>
                                                                                <th>Número OC</th>
                                                                                <th>Posición</th>
                                                                                <th>Código Recepción</th>
                                                                                <th>Cantidad a Facturar</th>
                                                                                <th>Código Sociedad FI</th>
                                                                                <th>Proveedor SAP</th>
                                                                            </tr>
                                                                        </thead>
                                                                        <tbody>
                                                                            @foreach (var po in _selectedDocument.PurchaseOrders)
                                                                            {
                                                                                <tr>
                                                                                    <td>@po.NroOc</td>
                                                                                    <td>@po.PosicionOc</td>
                                                                                    <td>@po.CodigoRecepcion</td>
                                                                                    <td>@po.CantidadAfacturar.ToString("N2")</td>
                                                                                    <td>@po.CodigoSociedadFi</td>
                                                                                    <td>@po.ProveedorSap</td>
                                                                                </tr>
                                                                            }
                                                                        </tbody>
                                                                    </table>
                                                                </div>
                                                            }
                                                            else
                                                            {
                                                                <div class="alert alert-info mb-0">
                                                                    <i class="ri-information-line me-2"></i>No hay órdenes de compra asociadas a este documento.
                                                                </div>
                                                            }
                                                        </div>
                                                    </div>
                                                </form>
                                            </div>

                                            <!-- Paso 3: Notas -->
                                            <div class="tab-pane fade" id="notes-step">
                                                <form id="notesForm" method="post" action="#" class="form-horizontal">
                                                    <div class="card shadow-sm border border-success-subtle">
                                                        <div class="card-header bg-success-subtle">
                                                            <h5 class="card-title mb-0">
                                                                <i class="ri-sticky-note-line me-2"></i> Notas
                                                            </h5>
                                                        </div>
                                                        <div class="card-body">
                                                            @if (IsPendingPreloadStatus(_selectedDocument))
                                                            {
                                                                <div class="alert alert-info mb-0">
                                                                    <i class="ri-information-line me-2"></i>
                                                                    <strong>Información:</strong> Solo podrá editar notas cuando el documento no esté en estado "Pendiente Precarga".
                                                                </div>
                                                            }
                                                            else if (_selectedDocument.Notes.Any())
                                                            {
                                                                <div>
                                                                    <table id="edit-document-notes-datatable" class="table table-striped w-100 nowrap">
                                                                        <thead>
                                                                            <tr>
                                                                                <th>Usuario</th>
                                                                                <th>Fecha</th>
                                                                                <th>Observaciones</th>
                                                                            </tr>
                                                                        </thead>
                                                                        <tbody>
                                                                            @foreach (var note in _selectedDocument.Notes)
                                                                            {
                                                                                <tr>
                                                                                    <td>@note.UsuarioCreacion</td>
                                                                                    <td>@note.FechaCreacion.ToString("dd/MM/yyyy")</td>
                                                                                    <td>@note.Descripcion</td>
                                                                                </tr>
                                                                            }
                                                                        </tbody>
                                                                    </table>
                                                                </div>
                                                            }
                                                            else
                                                            {
                                                                <div class="alert alert-info mb-0">
                                                                    <i class="ri-information-line me-2"></i>No hay notas disponibles.
                                                                </div>
                                                            }
                                                        </div>
                                                    </div>
                                                </form>
                                            </div>

                                            <!-- Botones de navegación del wizard -->
                                            <div class="d-flex wizard justify-content-between flex-wrap gap-2 mt-3">
                                                <div class="first">
                                                    <a href="javascript:void(0);" class="btn btn-primary">
                                                        Inicio
                                                    </a>
                                                </div>
                                                <div class="d-flex flex-wrap gap-2">
                                                    <div class="previous">
                                                        <a href="javascript:void(0);" class="btn btn-primary">
                                                            <i class="ri-arrow-left-line me-2"></i>Anterior
                                                        </a>
                                                    </div>
                                                    <div class="next">
                                                        <a href="javascript:void(0);" class="btn btn-primary mt-3 mt-md-0">
                                                            Siguiente<i class="ri-arrow-right-line ms-2"></i>
                                                        </a>
                                                    </div>
                                                </div>
                                                <div class="last" style="display: none;">
                                                    <a href="javascript:void(0);" class="btn btn-success mt-3 mt-md-0">
                                                        <i class="ri-save-line me-1"></i>Guardar
                                                    </a>
                                                </div>
                                            </div>
                                        </div> <!-- tab-content -->
                                    </div> <!-- end #edit-document-wizard-->
                                </div>
                                <!-- Mitad derecha: Visualización de PDF -->
                                <div class="col-md-6 ps-4">
                                    <div class="card shadow-sm border border-info-subtle">
                                        <div class="card-header bg-info-subtle">
                                            <h5 class="card-title mb-0">
                                                <i class="ri-file-pdf-line me-2"></i> PDF del Documento
                                            </h5>
                                        </div>
                                        <div class="card-body">
                                            @if (HasAttachment())
                                            {
                                                <PdfViewer AdjuntoId="@GetFirstAttachmentId()" OnError="HandlePdfError" />
                                            }
                                            else
                                            {
                                                <div class="mb-3">
                                                    <label for="pdfFileEdit" class="form-label fw-bold">Seleccionar archivo PDF</label>
                                                    <InputFile OnChange="HandlePdfFileSelected" class="form-control" id="pdfFileEdit" accept=".pdf,application/pdf" />
                                                    <div class="form-text">Tamaño máximo: 6 MB. Solo archivos PDF.</div>
                                                </div>
                                                <div class="d-flex justify-content-center align-items-center border rounded p-4 bg-light" style="min-height: 300px;">
                                                    <div class="text-center text-muted">
                                                        <i class="ri-file-upload-line" style="font-size: 3rem;"></i>
                                                        <p class="mt-2 mb-0">Arrastre y suelte el PDF aquí<br />o haga clic para seleccionar</p>
                                                    </div>
                                                </div>
                                                @if (!string.IsNullOrWhiteSpace(_selectedPdfFileName))
                                                {
                                                    <div class="mt-3">
                                                        <div class="alert alert-success d-flex align-items-center" role="alert">
                                                            <i class="ri-checkbox-circle-line me-2"></i>
                                                            <div>
                                                                <strong>Archivo seleccionado:</strong> @_selectedPdfFileName
                                                            </div>
                                                        </div>
                                                    </div>
                                                }
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="d-flex justify-content-end gap-2">
                                        <button type="button" class="btn btn-secondary" @onclick="NavigateToDocuments">
                                            <i class="ri-close-line me-1"></i>Cancelar
                                        </button>
                                        @if (!IsPendingPreloadStatus(_selectedDocument))
                                        {
                                            <button type="button" class="btn btn-primary" disabled>
                                                <i class="ri-save-line me-1"></i>Guardar Cambios
                                            </button>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- End Document Edit Tab -->
}
