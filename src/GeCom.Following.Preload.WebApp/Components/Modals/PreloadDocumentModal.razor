@using GeCom.Following.Preload.Contracts.Preload.Documents
@using GeCom.Following.Preload.WebApp.Services
@using Microsoft.AspNetCore.Components.Forms

<div class="modal fade" id="preloadDocumentModal" tabindex="-1" aria-labelledby="preloadDocumentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="preloadDocumentModalLabel">
                    <i class="ri-file-upload-line me-2"></i> Precargar Documento
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar" @onclick="CloseModal"></button>
            </div>
            <div class="modal-body">
                @if (_isUploading)
                {
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Subiendo archivo...</span>
                        </div>
                        <p class="mt-3">Subiendo archivo PDF, por favor espere...</p>
                    </div>
                }
                else
                {
                    <EditForm Model="@_preloadModel" OnValidSubmit="HandleFileUpload">
                        <DataAnnotationsValidator />
                        <div class="mb-3">
                            <label for="pdfFile" class="form-label">Seleccionar archivo PDF</label>
                            <InputFile OnChange="HandleFileSelected" class="form-control" id="pdfFile" accept=".pdf,application/pdf" />
                            <div class="form-text">Tamaño máximo: 6 MB. Solo archivos PDF.</div>
                            @if (!string.IsNullOrWhiteSpace(_selectedFileName))
                            {
                                <div class="mt-2">
                                    <span class="badge bg-info">
                                        <i class="ri-file-pdf-line me-1"></i> @_selectedFileName
                                    </span>
                                </div>
                            }
                            @if (!string.IsNullOrWhiteSpace(_errorMessage))
                            {
                                <div class="text-danger small mt-1">@_errorMessage</div>
                            }
                        </div>
                        <div class="d-flex justify-content-end gap-2">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" @onclick="CloseModal">
                                Cancelar
                            </button>
                            <button type="submit" class="btn btn-primary" disabled="@(!_hasFileSelected || _isUploading)">
                                <i class="ri-upload-cloud-line me-1"></i> Subir y Precargar
                            </button>
                        </div>
                    </EditForm>
                }
            </div>
        </div>
    </div>
</div>

@code {
    private bool _isUploading;
    private bool _hasFileSelected;
    private string _selectedFileName = string.Empty;
    private string _errorMessage = string.Empty;
    private IBrowserFile? _selectedFile;
    private readonly object _preloadModel = new();

    [Parameter] public EventCallback<DocumentResponse> OnDocumentPreloaded { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    [Inject] private IDocumentService DocumentService { get; set; } = default!;
    [Inject] private IJSRuntime JsRuntime { get; set; } = default!;

    private void HandleFileSelected(InputFileChangeEventArgs e)
    {
        _errorMessage = string.Empty;
        _selectedFile = e.File;

        // Validate file type
        if (!string.Equals(_selectedFile.ContentType, "application/pdf", StringComparison.OrdinalIgnoreCase) &&
            !_selectedFile.Name.EndsWith(".pdf", StringComparison.OrdinalIgnoreCase))
        {
            _errorMessage = "Solo se permiten archivos PDF.";
            _hasFileSelected = false;
            _selectedFileName = string.Empty;
            return;
        }

        // Validate file size (6 MB max)
        const long maxFileSize = 6 * 1024 * 1024; // 6 MB
        if (_selectedFile.Size > maxFileSize)
        {
            _errorMessage = $"El archivo excede el tamaño máximo de 6 MB. Tamaño actual: {(_selectedFile.Size / 1024.0 / 1024.0):F2} MB.";
            _hasFileSelected = false;
            _selectedFileName = string.Empty;
            return;
        }

        _hasFileSelected = true;
        _selectedFileName = _selectedFile.Name;
    }

    private async Task HandleFileUpload()
    {
        if (_selectedFile is null || !_hasFileSelected)
        {
            _errorMessage = "Por favor seleccione un archivo PDF.";
            return;
        }

        try
        {
            _isUploading = true;
            _errorMessage = string.Empty;
            StateHasChanged();

            DocumentResponse? document = await DocumentService.PreloadDocumentAsync(_selectedFile);

            if (document is null)
            {
                _errorMessage = "No se pudo crear el documento. Por favor intente nuevamente.";
                return;
            }

            // Close modal
            await JsRuntime.InvokeVoidAsync("eval", "bootstrap.Modal.getInstance(document.getElementById('preloadDocumentModal'))?.hide()");

            // Notify parent component
            await OnDocumentPreloaded.InvokeAsync(document);
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error al subir el archivo: {ex.Message}";
        }
        finally
        {
            _isUploading = false;
            StateHasChanged();
        }
    }

    private async Task CloseModal()
    {
        await OnCancel.InvokeAsync();
        ResetForm();
    }

    private void ResetForm()
    {
        _selectedFile = null;
        _hasFileSelected = false;
        _selectedFileName = string.Empty;
        _errorMessage = string.Empty;
        _isUploading = false;
    }

    public async Task ShowAsync()
    {
        ResetForm();
        await JsRuntime.InvokeVoidAsync("eval", "new bootstrap.Modal(document.getElementById('preloadDocumentModal')).show()");
    }
}

