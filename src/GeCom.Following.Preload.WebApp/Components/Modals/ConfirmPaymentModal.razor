@using GeCom.Following.Preload.Contracts.Preload.Documents
@using Microsoft.AspNetCore.Components.Forms

<div class="modal fade" id="confirmPaymentModal" tabindex="-1" aria-labelledby="confirmPaymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmPaymentModalLabel">
                    <i class="ri-checkbox-circle-line me-2"></i> Confirmar Pago
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar" @onclick="CloseModal"></button>
            </div>
            <div class="modal-body">
                @if (_isProcessing)
                {
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Procesando...</span>
                        </div>
                        <p class="mt-3">Confirmando el pago, por favor espere...</p>
                    </div>
                }
                else
                {
                    <div class="card shadow-sm border border-success-subtle">
                        <div class="card-header bg-success-subtle">
                            <h5 class="card-title mb-0">
                                <i class="ri-money-dollar-circle-line me-2"></i> Confirmación de Pago
                            </h5>
                        </div>
                        <div class="card-body">
                            @if (_selectedDocument is not null)
                            {
                                <div class="mb-3">
                                    <p class="mb-2"><strong>Documento:</strong> #@_selectedDocument.DocId</p>
                                    <p class="mb-2"><strong>Proveedor:</strong> @_selectedDocument.ProveedorRazonSocial</p>
                                    <p class="mb-0"><strong>Monto:</strong> @(_selectedDocument.MontoBruto?.ToString("N2")) @_selectedDocument.Moneda</p>
                                </div>
                                <hr />
                            }

                            <EditForm Model="@_paymentModel" OnValidSubmit="HandleConfirmPayment">
                                <DataAnnotationsValidator />
                                
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Método de Pago <span class="text-danger">*</span></label>
                                    <div class="mt-2">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" 
                                                   type="radio" 
                                                   name="paymentMethod" 
                                                   id="transferencia" 
                                                   value="Transferencia"
                                                   checked="@(_selectedPaymentMethod == "Transferencia")"
                                                   @onchange="@(() => OnPaymentMethodChanged("Transferencia"))" />
                                            <label class="form-check-label" for="transferencia">
                                                <i class="ri-bank-line me-1"></i> Transferencia
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" 
                                                   type="radio" 
                                                   name="paymentMethod" 
                                                   id="cheque" 
                                                   value="Cheque o echeq"
                                                   checked="@(_selectedPaymentMethod == "Cheque o echeq")"
                                                   @onchange="@(() => OnPaymentMethodChanged("Cheque o echeq"))" />
                                            <label class="form-check-label" for="cheque">
                                                <i class="ri-file-text-line me-1"></i> Cheque o echeq
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                @if (_selectedPaymentMethod == "Cheque o echeq")
                                {
                                    <div class="border-top pt-3 mt-3">
                                        <h6 class="mb-3"><i class="ri-file-text-line me-2"></i> Datos del Cheque</h6>
                                        
                                        <div class="mb-3">
                                            <label for="numeroCheque" class="form-label">Nro de Cheque <span class="text-danger">*</span></label>
                                            <InputText id="numeroCheque" 
                                                      class="@NumeroChequeClass" 
                                                      @bind-Value="_numeroCheque" 
                                                      @onblur="ValidateChequeFields" />
                                            @if (_validationErrors.ContainsKey("NumeroCheque"))
                                            {
                                                <div class="invalid-feedback">@_validationErrors["NumeroCheque"]</div>
                                            }
                                        </div>

                                        <div class="mb-3">
                                            <label for="banco" class="form-label">Banco <span class="text-danger">*</span></label>
                                            <InputText id="banco" 
                                                      class="@BancoClass" 
                                                      @bind-Value="_banco" 
                                                      @onblur="ValidateChequeFields" />
                                            @if (_validationErrors.ContainsKey("Banco"))
                                            {
                                                <div class="invalid-feedback">@_validationErrors["Banco"]</div>
                                            }
                                        </div>

                                        <div class="mb-3">
                                            <label for="vencimiento" class="form-label">Vencimiento <span class="text-danger">*</span></label>
                                            <InputDate id="vencimiento" 
                                                      class="@VencimientoClass" 
                                                      @bind-Value="_vencimiento" 
                                                      @onblur="ValidateChequeFields" />
                                            @if (_validationErrors.ContainsKey("Vencimiento"))
                                            {
                                                <div class="invalid-feedback">@_validationErrors["Vencimiento"]</div>
                                            }
                                        </div>
                                    </div>
                                }

                                @if (!string.IsNullOrWhiteSpace(_errorMessage))
                                {
                                    <div class="alert alert-danger mt-3 mb-0">
                                        <i class="ri-error-warning-line me-2"></i>@_errorMessage
                                    </div>
                                }

                                <div class="d-flex justify-content-end gap-2 mt-4">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" @onclick="CloseModal">
                                        <i class="ri-close-line me-1"></i> Cancelar
                                    </button>
                                    <button type="submit" 
                                            class="btn btn-success" 
                                            disabled="@(!CanConfirmPayment)">
                                        <i class="ri-checkbox-circle-line me-1"></i> Aceptar
                                    </button>
                                </div>
                            </EditForm>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>
